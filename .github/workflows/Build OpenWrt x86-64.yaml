name: Build OpenWrt x86-64

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release 标签名'
        required: true
        default: 'nightly'
      version:
        description: '固件版本号'
        required: true
        default: 'v1.0'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: openwrt-24.10
  TARGET_ARCH: x86/64

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    outputs:
      build_time: ${{ steps.setup_vars.outputs.build_time }}
      firmware_files: ${{ steps.find_files.outputs.firmware_files }}

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置变量
      id: setup_vars
      run: |
        BUILD_TIME=$(date +'%Y%m%d-%H%M%S')
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV

    - name: 准备构建环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
          file wget curl

    - name: 克隆 OpenWrt 源码
      run: |
        git clone ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} --depth 1
        cd openwrt
        echo "OpenWrt 版本:"
        git log --oneline -1

    - name: 应用配置文件
      run: |
        cd openwrt
        
        # 复制配置文件
        if [ -f ../X86-64.config ]; then
          echo "使用自定义配置文件"
          cp ../X86-64.config .config
        else
          echo "使用默认配置"
          make defconfig
        fi
        
        # 执行自定义脚本
        if [ -f ../diy-part1.sh ]; then
          echo "执行 diy-part1.sh..."
          chmod +x ../diy-part1.sh
          cp ../diy-part1.sh .
          ./diy-part1.sh
        fi
        
        if [ -f ../diy-part2.sh ]; then
          echo "执行 diy-part2.sh..."
          chmod +x ../diy-part2.sh
          cp ../diy-part2.sh .
          ./diy-part2.sh
        fi
        
        # 复制 feeds 配置
        if [ -f ../feeds.conf.default ]; then
          cp ../feeds.conf.default .
        fi

    - name: 更新 feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 最终配置
      run: |
        cd openwrt
        make defconfig
        echo "配置完成"

    - name: 下载依赖包
      run: |
        cd openwrt
        echo "下载依赖包..."
        make -j$(nproc) download
        echo "清理无效下载..."
        find dl -size -1024c -delete 2>/dev/null || true

    - name: 编译固件
      run: |
        cd openwrt
        export FORCE_UNSAFE_CONFIGURE=1
        echo "开始编译固件..."
        make -j$(nproc) V=s 2>&1 | tee build.log
        
        if [ $? -eq 0 ]; then
          echo "编译成功!"
        else
          echo "编译失败!"
          exit 1
        fi

    - name: 检查编译输出
      id: find_files
      run: |
        cd openwrt
        
        # 创建输出目录
        mkdir -p /tmp/firmware_output
        
        # 查找所有固件文件
        echo "查找固件文件..."
        FIRMWARE_FILES=""
        
        # 查找主要固件文件
        for file in bin/targets/${{ env.TARGET_ARCH }}/*; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "找到文件: $filename"
            
            # 复制到临时目录
            cp "$file" "/tmp/firmware_output/"
            
            # 添加到文件列表
            if [ -z "$FIRMWARE_FILES" ]; then
              FIRMWARE_FILES="$filename"
            else
              FIRMWARE_FILES="$FIRMWARE_FILES,$filename"
            fi
          fi
        done
        
        # 列出所有找到的文件
        echo "输出目录内容:"
        ls -la /tmp/firmware_output/
        
        # 输出文件列表
        echo "firmware_files=$FIRMWARE_FILES" >> $GITHUB_OUTPUT
        
        # 创建信息文件
        cat > /tmp/firmware_output/build-info.txt << EOF
OpenWrt x86-64 固件
=====================

构建时间: ${{ env.BUILD_TIME }}
OpenWrt 版本: ${{ env.REPO_BRANCH }}
内核版本: 6.12
管理地址: 192.168.6.1
默认主题: luci-theme-argon

包含插件:
- luci-app-adguardhome (含核心)
- luci-app-openclash (含核心)
- luci-app-turboacc
- luci-app-dockerman
- luci-app-samba4
- luci-app-upnp
- luci-app-argon-config
- luci-app-quickstart
- luci-app-store
- luci-app-appfilter

使用方法:
1. 下载对应的固件文件
2. 写入硬盘或虚拟机
3. 访问 https://192.168.6.1
4. 用户名: root, 密码: (空)

注意:
- 首次登录后请立即修改密码
- AdGuardHome 和 OpenClash 核心会自动下载
EOF

    - name: 重命名固件文件
      run: |
        cd /tmp/firmware_output
        echo "重命名固件文件..."
        
        # 重命名所有文件
        for file in *; do
          if [ -f "$file" ] && [ "$file" != "build-info.txt" ]; then
            extension="${file##*.}"
            name="${file%.*}"
            
            # 如果是 .gz 文件，特殊处理
            if [[ "$file" == *.gz ]]; then
              name="${file%.gz}"
              new_name="${{ env.BUILD_TIME }}-openwrt-x86-64-$name.gz"
              echo "重命名: $file -> $new_name"
              mv "$file" "$new_name"
            else
              new_name="${{ env.BUILD_TIME }}-openwrt-x86-64-$name.$extension"
              echo "重命名: $file -> $new_name"
              mv "$file" "$new_name"
            fi
          fi
        done
        
        echo "重命名后的文件:"
        ls -la

    - name: 上传 Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-${{ env.BUILD_TIME }}
        path: /tmp/firmware_output/*
        retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
    - name: 下载固件文件
      uses: actions/download-artifact@v4
      with:
        name: openwrt-firmware-${{ needs.build.outputs.build_time }}
        path: ./firmware

    - name: 查看下载的文件
      run: |
        echo "下载的固件文件:"
        ls -la firmware/
        echo "文件列表结束"

    - name: 创建 GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_tag || 'nightly' }}-${{ needs.build.outputs.build_time }}
        name: OpenWrt x86-64 ${{ github.event.inputs.version || 'v1.0' }} (${{ needs.build.outputs.build_time }})
        body: |
          # OpenWrt x86-64 固件
          
          ## 构建信息
          - **构建时间**: ${{ needs.build.outputs.build_time }}
          - **版本号**: ${{ github.event.inputs.version || 'v1.0' }}
          - **标签**: ${{ github.event.inputs.release_tag || 'nightly' }}
          
          ## 固件特性
          - **内核版本**: 6.12
          - **管理地址**: 192.168.6.1
          - **默认主题**: luci-theme-argon
          - **分区大小**: 内核 64MB, RootFS 1024MB
          - **架构**: x86-64
          
          ## 包含插件
          - luci-app-adguardhome (自动下载核心)
          - luci-app-openclash (自动下载核心)
          - luci-app-turboacc
          - luci-app-dockerman
          - luci-app-samba4
          - luci-app-upnp
          - luci-app-argon-config
          - luci-app-quickstart
          - luci-app-store
          - luci-app-appfilter
          
          ## 网络优化
          - BBR 拥塞控制
          - 千兆/万兆网络优化
          - TCP 参数优化
          
          ## 使用方法
          1. 下载需要的固件文件
          2. 写入到硬盘或虚拟机
          3. 访问 https://192.168.6.1
          4. 用户名: root，密码: (空，首次登录后请立即修改)
          
          ## 注意事项
          - AdGuardHome 和 OpenClash 核心会在首次启动时自动下载
          - 建议在虚拟机中测试后再部署到物理机
          - 首次登录后请立即修改密码
          
          ## 文件说明
          文件名格式: `时间-openwrt-x86-64-类型.扩展名`
          
          | 文件类型 | 说明 |
          |----------|------|
          | `*combined*` | 完整固件，包含内核和文件系统 |
          | `*rootfs*` | 仅根文件系统 |
          | `*kernel*` | 仅内核 |
          | `*.img.gz` | 压缩的磁盘镜像 |
          | `*.vmdk` | VMware 虚拟机磁盘 |
          | `*.vdi` | VirtualBox 虚拟机磁盘 |
          | `*.iso` | 光盘镜像 |
          
          ### 推荐下载
          - 对于物理机: `时间-openwrt-x86-64-combined-squashfs.img.gz`
          - 对于虚拟机: `时间-openwrt-x86-64-combined-squashfs.vmdk` 或 `.vdi`
          
          **祝您使用愉快！**
        draft: false
        prerelease: false
        files: |
          firmware/*
        token: ${{ secrets.GITHUB_TOKEN }}
