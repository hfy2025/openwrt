name: Build iStoreOS with Custom IP (192.168.6.1)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'iStoreOS branch/version (e.g., istoreos-22.03)'
        required: true
        default: 'istoreos-22.03'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # ç¼–è¯‘å¯èƒ½è€—æ—¶è¾ƒé•¿ï¼Œè®¾ç½®è¶…æ—¶

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev \
        libncursesw5-dev libssl-dev python3 python3-pip python3-setuptools \
        python3-dev qemu-utils rsync subversion swig time unzip wget \
        zlib1g-dev

    - name: Clone iStoreOS Source Code
      run: |
        git clone --depth=1 https://github.com/istoreos/istoreos.git -b ${{ github.event.inputs.version || 'istoreos-22.03' }}
        cd istoreos

    - name: Modify Default IP Address to 192.168.6.1
      run: |
        cd istoreos
        # æ–¹æ³•1: ä¿®æ”¹ç½‘ç»œé…ç½®æ–‡ä»¶ (ä¸»è¦æ–¹æ³•)
        if [ -f "package/base-files/files/bin/config_generate" ]; then
          sed -i "s/ipaddr='192\.168\.[0-9]*\.[0-9]*'/ipaddr='192.168.6.1'/" package/base-files/files/bin/config_generate
          echo "âœ… Modified default IP in config_generate"
        fi
        
        # æ–¹æ³•2: é€šè¿‡diffconfigæ–‡ä»¶è®¾ç½® (å¤‡ç”¨æ–¹æ³•)
        echo "CONFIG_TARGET_IPADDR=\"192.168.6.1\"" >> .config
        echo "CONFIG_TARGET_NETMASK=\"255.255.255.0\"" >> .config
        echo "CONFIG_TARGET_GATEWAY=\"192.168.6.254\"" >> .config

    - name: Configure Build Settings
      run: |
        cd istoreos
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # ä½¿ç”¨é»˜è®¤é…ç½® (å¯æ ¹æ®éœ€è¦ä¿®æ”¹)
        cp configs/targets/x86_64.config .config
        make defconfig

    - name: Start Compilation
      run: |
        cd istoreos
        # å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨å¤šæ ¸åŠ é€Ÿ
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -f "bin/targets/x86/64/*-squashfs-combined.img.gz" ]; then
          echo "ğŸ‰ Build successful!"
          ls -la bin/targets/x86/64/
        else
          echo "âŒ Build failed!"
          exit 1
        fi

    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: iStoreOS-firmware-192.168.6.1
        path: istoreos/bin/targets/**/*.img.gz
        retention-days: 30

    - name: Upload Build Log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          istoreos/build.log
          istoreos/logs/
        retention-days: 7
