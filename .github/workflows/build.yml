name: Build ImmortalWrt X86-64

on:
  workflow_dispatch:
    inputs:
      skip_packages:
        description: 'Skip package download'
        required: false
        default: 'false'
      build_type:
        description: 'Build type'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - standard

env:
  CPU_CORES: 2
  MAKE_JOBS: 2
  BUILD_DIR: ${{ github.workspace }}/build

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Check disk space
      run: |
        df -h
        echo "Available space on /home/runner:"
        df -h /home/runner | tail -1
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Cleanup disk space
      run: |
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/doc/
        sudo rm -rf /usr/share/man/
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils \
          python3-dev git wget rsync file gawk unzip \
          zlib1g-dev gettext gcc g++ make bash perl patch
        
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-immortalwrt
        max-size: 300M
        
    - name: Clone source
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        git clone --depth=1 -b openwrt-25.12 \
          https://github.com/immortalwrt/immortalwrt.git
          
    - name: Update feeds
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Add Argon theme
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        git clone --depth=1 https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        
    - name: Create config file
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        # 基础配置
        echo "CONFIG_TARGET_x86=y" > .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=1024" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl-openssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        
        # 根据构建类型添加配置
        if [ "${{ github.event.inputs.build_type }}" = "standard" ]; then
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_ethtool=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-cake=y" >> .config
        else
          # minimal 构建
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_ethtool=y" >> .config
        fi
        
        make defconfig
        
    - name: Download packages
      if: ${{ github.event.inputs.skip_packages != 'true' }}
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        make download -j${{ env.CPU_CORES }} V=0
        
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        echo "开始编译..."
        make -j${{ env.MAKE_JOBS }} V=0
        
    - name: Check build result
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        if ls bin/targets/x86/64/*.img.gz 1> /dev/null 2>&1; then
          echo "✅ 编译成功！"
          ls -lh bin/targets/x86/64/*.img.gz
        else
          echo "❌ 编译失败"
          exit 1
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-x86-64
        path: ${{ env.BUILD_DIR }}/immortalwrt/bin/targets/x86/64/*.img.gz
        retention-days: 7
