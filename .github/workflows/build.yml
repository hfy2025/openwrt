name: Build OpenWrt（编译固件）

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: true
        default: 'v1.0'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: X86-64.config

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: openwrtorg/sdk:x86_64-24.10
      options: --privileged

    steps:
    - name: 检出仓库
      uses: actions/checkout@v4
      with:
        path: openwrt-build

    - name: 克隆 OpenWrt 源码
      run: |
        git clone $REPO_URL --branch $REPO_BRANCH --depth 1 openwrt-source
        cd openwrt-source

    - name: 更新 feeds
      run: |
        cd openwrt-source
        cp ../openwrt-build/$FEEDS_CONF .
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 应用自定义脚本
      run: |
        cd openwrt-source
        cp ../openwrt-build/diy-part1.sh .
        cp ../openwrt-build/diy-part2.sh .
        chmod +x diy-part1.sh diy-part2.sh
        ./diy-part1.sh
        ./diy-part2.sh

    - name: 复制配置文件
      run: |
        cd openwrt-source
        cp ../openwrt-build/$CONFIG_FILE .config
        make defconfig

    - name: 下载依赖
      run: |
        cd openwrt-source
        make download -j$(nproc)
        find dl -size -1024c -exec rm -f {} \;

    - name: 编译固件
      run: |
        cd openwrt-source
        make -j$(nproc) V=s

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-x86-64-${{ github.sha }}
        path: openwrt-source/bin/targets/x86/64/
