name: Build OpenWrt x86-64

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: true
        default: 'v1.0'
      clean_build:
        description: '完全清理构建'
        type: boolean
        default: false
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: X86-64.config
  BUILD_TARGET: x86/64
  BUILD_JOBS: 4

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      build_time: ${{ steps.timestamp.outputs.time }}
      commit_hash: ${{ steps.get_hash.outputs.hash }}
    steps:
      - name: 获取时间戳
        id: timestamp
        run: echo "time=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        
      - name: 获取提交哈希
        id: get_hash
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: 检查环境
      run: |
        echo "工作空间: ${{ github.workspace }}"
        echo "运行器信息:"
        uname -a
        echo "内存:"
        free -h
        echo "磁盘:"
        df -h

    - name: 检出仓库代码
      uses: actions/checkout@v4
      with:
        path: openwrt-config

    - name: 设置 Docker 容器环境
      run: |
        echo "准备 Docker 环境..."

    - name: 在 Docker 容器中构建
      uses: docker://openwrtorg/sdk:x86_64-24.10
      with:
        args: /bin/sh -c "
          echo '容器内构建开始...' &&
          whoami &&
          id &&
          
          # 创建工作目录
          mkdir -p /home/build &&
          cd /home/build &&
          
          # 克隆 OpenWrt 源码
          echo '克隆 OpenWrt 源码...' &&
          git clone ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} --depth 1 openwrt &&
          cd openwrt &&
          
          # 复制配置文件
          echo '复制配置文件...' &&
          cp /github/workspace/openwrt-config/feeds.conf.default . 2>/dev/null || true &&
          cp /github/workspace/openwrt-config/${{ env.CONFIG_FILE }} .config 2>/dev/null || true &&
          
          # 更新 feeds
          echo '更新 feeds...' &&
          ./scripts/feeds update -a &&
          ./scripts/feeds install -a &&
          
          # 执行自定义脚本
          if [ -f /github/workspace/openwrt-config/diy-part1.sh ]; then
            echo '执行 diy-part1.sh...' &&
            cp /github/workspace/openwrt-config/diy-part1.sh . &&
            chmod +x diy-part1.sh &&
            ./diy-part1.sh
          fi &&
          
          if [ -f /github/workspace/openwrt-config/diy-part2.sh ]; then
            echo '执行 diy-part2.sh...' &&
            cp /github/workspace/openwrt-config/diy-part2.sh . &&
            chmod +x diy-part2.sh &&
            ./diy-part2.sh
          fi &&
          
          # 配置检查
          echo '配置检查...' &&
          make defconfig &&
          
          # 下载源码包
          echo '下载源码包...' &&
          make -j${{ env.BUILD_JOBS }} download &&
          find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true &&
          
          # 开始编译
          echo '开始编译...' &&
          export FORCE_UNSAFE_CONFIGURE=1 &&
          if [ '${{ github.event.inputs.clean_build }}' = 'true' ]; then
            make clean &&
            make -j${{ env.BUILD_JOBS }} V=s
          else
            make -j${{ env.BUILD_JOBS }} V=sc
          fi &&
          
          echo '编译完成！' &&
          ls -la bin/targets/${{ env.BUILD_TARGET }}/ &&
          
          # 复制固件到工作空间
          mkdir -p /github/workspace/firmware &&
          cp -r bin/targets/${{ env.BUILD_TARGET }}/* /github/workspace/firmware/ &&
          
          echo '固件已复制到工作空间'
        "

    - name: 复制固件到工作流
      run: |
        echo "检查固件文件..."
        ls -la /github/workspace/firmware/ || echo "没有找到固件目录"
        mkdir -p firmware-output
        cp -r /github/workspace/firmware/* firmware-output/ 2>/dev/null || true
        echo "固件输出目录内容:"
        ls -la firmware-output/ || echo "输出目录为空"

    - name: 上传固件到工作流
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-x86-64-${{ needs.prepare.outputs.build_time }}
        path: firmware-output/*
        retention-days: 7
        compression-level: 9

    - name: 上传构建日志
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs-${{ needs.prepare.outputs.build_time }}
        path: |
          /github/workspace/openwrt-config/*
          firmware-output/*.log 2>/dev/null || true
        retention-days: 7

  release:
    needs: [prepare, build]
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    
    steps:
    - name: 下载构建的固件
      uses: actions/download-artifact@v4
      with:
        name: openwrt-x86-64-${{ needs.prepare.outputs.build_time }}
        path: artifacts

    - name: 创建发布版本
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.event.inputs.version }}-${{ needs.prepare.outputs.build_time }}
        name: OpenWrt x86-64 ${{ github.event.inputs.version }}
        body: |
          # OpenWrt x86-64 固件
          
          **构建信息**
          - 时间: ${{ needs.prepare.outputs.build_time }}
          - 提交: ${{ needs.prepare.outputs.commit_hash }}
          - 版本: ${{ github.event.inputs.version }}
          - 内核: 6.12
          
          **特性**
          - 管理地址: 192.168.6.1
          - 默认主题: luci-theme-argon
          - 分区: 内核 64MB, RootFS 1024MB
          - 千兆/万兆网络优化
          
          **包含插件**
          - luci-app-adguardhome
          - luci-app-openclash
          - luci-app-turboacc
          - luci-app-dockerman
          - luci-app-samba4
          - 等常用插件
          
          **使用方法**
          1. 下载对应的镜像文件
          2. 写入到硬盘或虚拟机
          3. 访问 https://192.168.6.1
          4. 用户名: root，密码: (空)
        artifacts: |
          artifacts/*
        draft: false
        prerelease: false
