name: Build OpenWrt x86-64

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: true
        default: 'v1.0'
      clean_build:
        description: '完全清理构建'
        type: boolean
        default: false
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: X86-64.config
  BUILD_TARGET: x86/64
  BUILD_JOBS: 4

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      build_time: ${{ steps.timestamp.outputs.time }}
      commit_hash: ${{ steps.get_hash.outputs.hash }}
    steps:
      - name: 获取时间戳
        id: timestamp
        run: echo "time=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        
      - name: 获取提交哈希
        id: get_hash
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    container:
      image: openwrtorg/sdk:x86_64-24.10
      options: --user root --privileged --network host

    steps:
    - name: 检查容器环境
      run: |
        echo "容器信息:"
        uname -a
        echo "内存:"
        free -h
        echo "磁盘:"
        df -h
        echo "CPU信息:"
        cat /proc/cpuinfo | grep "model name" | head -1

    - name: 检出仓库代码
      uses: actions/checkout@v4
      with:
        path: ${{ github.workspace }}/config

    - name: 设置构建环境
      run: |
        echo "设置构建参数..."
        export BUILDER_UID=$(id -u)
        export BUILDER_GID=$(id -g)
        echo "用户: $BUILDER_UID:$BUILDER_GID"

    - name: 克隆 OpenWrt 源码
      run: |
        echo "开始克隆 OpenWrt 源码..."
        cd ${{ github.workspace }}
        git clone --depth=1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
        cd openwrt
        echo "源码版本:"
        git log --oneline -1
        
    - name: 准备 feeds 配置
      run: |
        cd ${{ github.workspace }}/openwrt
        if [ -f ${{ github.workspace }}/config/${{ env.FEEDS_CONF }} ]; then
          cp ${{ github.workspace }}/config/${{ env.FEEDS_CONF }} .
        else
          # 默认 feeds 配置
          cat > feeds.conf.default << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
src-git telephony https://git.openwrt.org/feed/telephony.git
EOF
        fi

    - name: 更新和安装 feeds
      run: |
        cd ${{ github.workspace }}/openwrt
        echo "更新 feeds..."
        ./scripts/feeds update -a
        echo "安装 feeds..."
        ./scripts/feeds install -a

    - name: 应用自定义配置 - Part 1
      run: |
        cd ${{ github.workspace }}/openwrt
        if [ -f ${{ github.workspace }}/config/diy-part1.sh ]; then
          echo "执行 diy-part1.sh..."
          chmod +x ${{ github.workspace }}/config/diy-part1.sh
          cp ${{ github.workspace }}/config/diy-part1.sh .
          ./diy-part1.sh
        else
          echo "diy-part1.sh 不存在，跳过..."
        fi

    - name: 应用自定义配置 - Part 2
      run: |
        cd ${{ github.workspace }}/openwrt
        if [ -f ${{ github.workspace }}/config/diy-part2.sh ]; then
          echo "执行 diy-part2.sh..."
          chmod +x ${{ github.workspace }}/config/diy-part2.sh
          cp ${{ github.workspace }}/config/diy-part2.sh .
          ./diy-part2.sh
        else
          echo "diy-part2.sh 不存在，跳过..."
        fi

    - name: 复制配置文件
      run: |
        cd ${{ github.workspace }}/openwrt
        if [ -f ${{ github.workspace }}/config/${{ env.CONFIG_FILE }} ]; then
          echo "复制配置文件..."
          cp ${{ github.workspace }}/config/${{ env.CONFIG_FILE }} .config
        else
          echo "配置文件不存在，使用默认配置..."
          make defconfig
        fi

    - name: 配置检查
      run: |
        cd ${{ github.workspace }}/openwrt
        echo "检查配置..."
        make defconfig
        echo "当前配置摘要:"
        grep -E "CONFIG_TARGET|CONFIG_PACKAGE|CONFIG_KERNEL" .config | head -20

    - name: 下载源码包
      run: |
        cd ${{ github.workspace }}/openwrt
        echo "开始下载源码包..."
        make -j${{ env.BUILD_JOBS }} download
        echo "下载完成，检查完整性..."
        find dl -size -1024c -exec ls -la {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: 开始编译
      run: |
        cd ${{ github.workspace }}/openwrt
        echo "开始编译固件..."
        # 设置编译参数
        export FORCE_UNSAFE_CONFIGURE=1
        # 开始编译
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "执行完全清理构建..."
          make clean
          make -j${{ env.BUILD_JOBS }} V=s
        else
          make -j${{ env.BUILD_JOBS }} V=sc
        fi

    - name: 检查编译结果
      run: |
        cd ${{ github.workspace }}/openwrt
        echo "编译结果:"
        ls -la bin/targets/${{ env.BUILD_TARGET }}/
        echo "固件大小:"
        du -h bin/targets/${{ env.BUILD_TARGET }}/*.img.gz 2>/dev/null || echo "没有找到固件文件"

    - name: 上传固件到工作流
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-x86-64-${{ needs.prepare.outputs.build_time }}
        path: ${{ github.workspace }}/openwrt/bin/targets/${{ env.BUILD_TARGET }}/*
        retention-days: 7
        compression-level: 9

    - name: 上传配置文件
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: config-files-${{ needs.prepare.outputs.build_time }}
        path: |
          ${{ github.workspace }}/openwrt/.config
          ${{ github.workspace }}/openwrt/feeds.conf
          ${{ github.workspace }}/openwrt/feeds.conf.default
        retention-days: 7

  release:
    needs: [prepare, build]
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    
    steps:
    - name: 下载构建的固件
      uses: actions/download-artifact@v4
      with:
        name: openwrt-x86-64-${{ needs.prepare.outputs.build_time }}
        path: artifacts

    - name: 创建发布版本
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}-${{ needs.prepare.outputs.build_time }}
        name: OpenWrt x86-64 ${{ github.event.inputs.version }}
        body: |
          # OpenWrt x86-64 固件
          
          **构建信息**
          - 时间: ${{ needs.prepare.outputs.build_time }}
          - 提交: ${{ needs.prepare.outputs.commit_hash }}
          - 版本: ${{ github.event.inputs.version }}
          - 内核: 6.12
          
          **特性**
          - 管理地址: 192.168.6.1
          - 默认主题: luci-theme-argon
          - 分区: 内核 64MB, RootFS 1024MB
          - 千兆/万兆网络优化
          
          **包含插件**
          - luci-app-adguardhome
          - luci-app-openclash
          - luci-app-turboacc
          - luci-app-dockerman
          - luci-app-samba4
          - 等常用插件
          
          **使用方法**
          1. 下载对应的镜像文件
          2. 写入到硬盘或虚拟机
          3. 访问 https://192.168.6.1
          4. 用户名: root，密码: (空)
          
        draft: false
        prerelease: false
        files: |
          artifacts/*.img.gz
          artifacts/*.vmdk
          artifacts/*.vdi
          artifacts/*.iso
          artifacts/*.manifest
