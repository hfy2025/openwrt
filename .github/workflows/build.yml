#
# This workflow was generated by OpenWrt Action Gen
#
name: Build OpenWrt (ç¼–è¯‘å›ºä»¶)

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç  (Checkout)
      uses: actions/checkout@main

    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´ (Free Disk Space)
      run: |
        echo "Freeing up disk space..."
        echo "=========================================================="
        df -hT
        echo "=========================================================="
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        echo "=========================================================="
        df -hT
        echo "=========================================================="

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ (Initialization environment)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: å…‹éš†æºç  (Clone source code)
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: åŠ è½½è‡ªå®šä¹‰ Feeds (diy-part1.sh)
      run: |
        # Apply Custom Feeds from UI
        
        # Write DIY Part 1 Script
        # æ·»åŠ ç¬¬ä¸‰æ–¹æ’ä»¶æº (Feeds)
        # Kenzok8 (OpenClash, Nikki, HomeProxy ç­‰)
        echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
        echo 'src-git small https://github.com/kenzok8/small' >> feeds.conf.default
        
        # iStore å’Œ NAS ç›¸å…³ (Quickstart, iStore)
        echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
        echo 'src-git nas https://github.com/linkease/nas-packages.git;master' >> feeds.conf.default
        
        # Argon ä¸»é¢˜ (æ‰‹åŠ¨å…‹éš†)
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/jerrykuku/luci-app-argon-config.git package/luci-app-argon-config
        
        chmod +x $DIY_P1_SH
        cd openwrt
        # Execute inline or file logic here. 
        # Applying DIY Part 1 Logic:
        # æ·»åŠ ç¬¬ä¸‰æ–¹æ’ä»¶æº (Feeds)
        # Kenzok8 (OpenClash, Nikki, HomeProxy ç­‰)
        echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
        echo 'src-git small https://github.com/kenzok8/small' >> feeds.conf.default
        
        # iStore å’Œ NAS ç›¸å…³ (Quickstart, iStore)
        echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
        echo 'src-git nas https://github.com/linkease/nas-packages.git;master' >> feeds.conf.default
        
        # Argon ä¸»é¢˜ (æ‰‹åŠ¨å…‹éš†)
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/jerrykuku/luci-app-argon-config.git package/luci-app-argon-config

    - name: ä¿®å¤ Rust CI ç¼–è¯‘é—®é¢˜
      run: |
        cd openwrt
        echo "ä¿®å¤ Rust CI ç¼–è¯‘é—®é¢˜..."
        
        # é¢„å…ˆä¸‹è½½å¹¶ä¿®å¤ Rust åŒ…
        mkdir -p feeds/packages/lang
        if [ ! -d feeds/packages/lang/rust ]; then
          echo "ä¸‹è½½ Rust åŒ…..."
          git clone --depth=1 https://github.com/openwrt/packages.git -b master packages-temp
          cp -r packages-temp/lang/rust feeds/packages/lang/ || true
          rm -rf packages-temp
        fi
        
        # ä¿®æ”¹ Rust Makefile ä»¥é¿å… CI é”™è¯¯
        if [ -f feeds/packages/lang/rust/Makefile ]; then
          echo "ä¿®æ”¹ Rust Makefile..."
          # ä¿®æ”¹ä¸‹è½½ CI LLVM çš„é…ç½®
          sed -i 's/--set llvm.download-ci-llvm=true/--set llvm.download-ci-llvm=if-unchanged/g' \
            feeds/packages/lang/rust/Makefile || true
          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„é…ç½®
          sed -i 's/RUSTC_DEFAULT_TARGET_LLVM_CMAKE:=true/RUSTC_DEFAULT_TARGET_LLVM_CMAKE:=false/g' \
            feeds/packages/lang/rust/Makefile || true
        fi

    - name: æ›´æ–° Feeds (Update feeds)
      run: cd openwrt && ./scripts/feeds update -a

    - name: å®‰è£… Feeds (Install feeds)
      run: cd openwrt && ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½® (diy-part2.sh)
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        cd openwrt
        
        # Applying DIY Part 2 Logic (System Settings):
        # ç½‘ç»œè®¾ç½®
        # è®¾ç½® LAN å£ IP ä¸º 192.168.6.1
        sed -i 's/192.168.1.1/192.168.6.1/g' package/base-files/files/bin/config_generate
        
        # --- åƒå…†ç½‘ç»œä¼˜åŒ– (1000M å¸¦å®½è·‘æ»¡) ---
        
        # 1. å¯ç”¨æµé‡åˆ†è½½ (è½¯ä»¶/ç¡¬ä»¶)
        # å¯¹äº 1000Mbps+ é€Ÿåº¦è‡³å…³é‡è¦ï¼Œå¯é™ä½ CPU è´Ÿè½½
        sed -i 's/option flow_offloading .*/option flow_offloading 1/' package/network/config/firewall/files/firewall.config
        sed -i '/option flow_offloading/a \
        \toption flow_offloading_hw 1' package/network/config/firewall/files/firewall.config
        
        # 2. æ·±åº¦ç³»ç»Ÿå†…æ ¸ä¼˜åŒ– (sysctl.conf)
        mkdir -p package/base-files/files/etc/sysctl.d
        cat <<EOF >> package/base-files/files/etc/sysctl.d/99-custom.conf
        # --- BBR æ‹¥å¡æ§åˆ¶ ---
        net.core.default_qdisc=fq
        net.ipv4.tcp_congestion_control=bbr
        
        # --- ç½‘ç»œç¼“å†²åŒºä¼˜åŒ– (é’ˆå¯¹åƒå…†/ä¸‡å…†) ---
        # å¢åŠ æ¥æ”¶å’Œå‘é€ç¼“å†²åŒºå¤§å°
        net.core.rmem_default=262144
        net.core.wmem_default=262144
        net.core.rmem_max=16777216
        net.core.wmem_max=16777216
        net.ipv4.tcp_rmem=4096 87380 16777216
        net.ipv4.tcp_wmem=4096 65536 16777216
        
        # --- è¿æ¥è·Ÿè¸ªä¸é˜Ÿåˆ—ä¼˜åŒ– ---
        net.core.netdev_max_backlog=16384
        net.core.somaxconn=8192
        net.ipv4.tcp_max_syn_backlog=8192
        net.ipv4.tcp_fastopen=3
        net.ipv4.tcp_keepalive_time=1200
        net.ipv4.tcp_window_scaling=1
        net.ipv4.tcp_timestamps=1
        
        # --- IPv6 ä¸“ç”¨ä¼˜åŒ– ---
        net.ipv6.conf.all.disable_ipv6=0
        net.ipv6.conf.default.disable_ipv6=0
        net.ipv6.conf.all.forwarding=1
        net.ipv6.conf.default.forwarding=1
        # å…è®¸æ›´å¤šçš„ IPv6 è·¯ç”±è¡¨æ¡ç›®
        net.ipv6.route.max_size=4096
        # é‚»å±…å‘ç°è¡¨å¤§å° (é˜²æ­¢å±€åŸŸç½‘è®¾å¤‡å¤šæ—¶ ARP æ»¡)
        net.ipv4.neigh.default.gc_thresh1=512
        net.ipv4.neigh.default.gc_thresh2=2048
        net.ipv4.neigh.default.gc_thresh3=4096
        net.ipv6.neigh.default.gc_thresh1=512
        net.ipv6.neigh.default.gc_thresh2=2048
        net.ipv6.neigh.default.gc_thresh3=4096
        EOF
        
        # 3. åœ¨ rc.local ä¸­å¯ç”¨æ•°æ®åŒ…æ§åˆ¶ (RPS)
        # å°†ç½‘ç»œä¸­æ–­åˆ†é…åˆ°æ‰€æœ‰ CPU æ ¸å¿ƒ
        sed -i "/exit 0/i \
        # ä¼˜åŒ–ï¼šå¯ç”¨æ•°æ®åŒ…æ§åˆ¶ (RPS)\n\
        for file in /sys/class/net/*/queues/rx-*/rps_cpus; do echo f > \$file; done\n\
        " package/base-files/files/etc/rc.local
        
        # 4. é¢å¤–ä¿®å¤ï¼šç¡®ä¿ Rust é…ç½®æ–‡ä»¶æ­£ç¡®
        if [ -f feeds/packages/lang/rust/files/config.toml ]; then
          sed -i 's/download-ci-llvm = true/download-ci-llvm = if-unchanged/g' \
            feeds/packages/lang/rust/files/config.toml || true
        fi

        # Inject Auto Update Config if enabled

    - name: ç”Ÿæˆ .config æ–‡ä»¶ (Generate .config)
      run: |
        cd openwrt
        
        # Write custom .config content
        cat <<EOF >> .config
        # ç›®æ ‡æ¶æ„: x86-64 (å†…æ ¸ 6.6)
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        
        # åˆ†åŒºè°ƒæ•´ (å†…æ ¸: 64MB, RootFS: 1024MB)
        CONFIG_TARGET_KERNEL_PARTSIZE=64
        CONFIG_TARGET_ROOTFS_PARTSIZE=1024
        
        # é•œåƒæ ¼å¼ï¼šåŒæ—¶ç”Ÿæˆå¤šç§æ ¼å¼
        CONFIG_TARGET_IMAGES_GZIP=y
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        
        # IPv6 æ”¯æŒ
        CONFIG_IPV6=y
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y
        CONFIG_PACKAGE_6in4=y
        CONFIG_PACKAGE_6rd=y
        CONFIG_PACKAGE_6to4=y
        
        # ä¸»é¢˜è®¾ç½®
        CONFIG_PACKAGE_luci-theme-argon=y
        CONFIG_PACKAGE_luci-theme-bootstrap=n
        CONFIG_PACKAGE_luci-app-argon-config=y
        
        # åƒå…†ç½‘ç»œä¼˜åŒ–åŒ…
        CONFIG_PACKAGE_kmod-tcp-bbr=y
        CONFIG_DEFAULT_tcp_bbr=y
        CONFIG_PACKAGE_irqbalance=y
        CONFIG_PACKAGE_luci-app-turboacc=y
        
        # ç¦ç”¨ Rust ä»¥é¿å… CI ç¼–è¯‘é”™è¯¯ï¼ˆå…³é”®ä¿®å¤ï¼‰
        CONFIG_PACKAGE_rust=n
        CONFIG_PACKAGE_rustc=n
        CONFIG_PACKAGE_cargo=n
        CONFIG_PACKAGE_rust-src=n
        CONFIG_PACKAGE_rustfmt=n
        CONFIG_PACKAGE_clippy=n
        
        # åŸºç¡€å·¥å…·å’Œåº“
        CONFIG_PACKAGE_bash=y
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_nano=y
        CONFIG_PACKAGE_wget=y
        CONFIG_PACKAGE_curl=y
        
        EOF

        # Applying User Selected Packages via .config appending
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-appfilter=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-homeproxy=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-quickstart=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-taskplan=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-argon-config=y" >> .config
        
        # ç¡®ä¿ç¦ç”¨æ‰€æœ‰ Rust ç›¸å…³é…ç½®
        echo "# ç¡®ä¿ç¦ç”¨ Rust" >> .config
        echo "CONFIG_PACKAGE_rust_HOST=y" >> .config  # ä¸»æœºå·¥å…·å¯ä»¥ä¿ç•™
        echo "CONFIG_PACKAGE_rust_TARGET=n" >> .config  # ç›®æ ‡å¹³å°ç¦ç”¨
        
        # Set to default for missing values
        sed -i 's/^[ 	]*//;s/[ 	]*$//' .config
        
        # å…ˆåšä¸€æ¬¡ defconfig
        make defconfig
        
        # å†æ¬¡ç¡®ä¿ Rust è¢«ç¦ç”¨
        sed -i 's/CONFIG_PACKAGE_rust=y/CONFIG_PACKAGE_rust=n/g' .config
        sed -i 's/CONFIG_PACKAGE_rustc=y/CONFIG_PACKAGE_rustc=n/g' .config
        sed -i 's/CONFIG_PACKAGE_cargo=y/CONFIG_PACKAGE_cargo=n/g' .config

    - name: ä¸‹è½½è½¯ä»¶åŒ… (Download package)
      id: package
      run: |
        cd openwrt
        # æ¸…ç†å¯èƒ½æŸåçš„ä¸‹è½½
        find dl -name "*rust*" -exec rm -f {} \; || true
        
        # ä¸‹è½½è½¯ä»¶åŒ…
        make download -j8
        
        # æ£€æŸ¥å¹¶åˆ é™¤æŸåçš„å°æ–‡ä»¶
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ Rust ç›¸å…³æ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™åˆ é™¤
        find dl -name "*rust*" -exec echo "åˆ é™¤ Rust æ–‡ä»¶: {}" \; -exec rm -f {} \; || true

    - name: ç¼–è¯‘å›ºä»¶ (Compile the firmware)
      id: compile
      run: |
        cd openwrt
        
        # æ£€æŸ¥ .config ç¡®ä¿ Rust è¢«ç¦ç”¨
        if grep -q "CONFIG_PACKAGE_rust=y" .config; then
          echo "è­¦å‘Šï¼šRust åœ¨ .config ä¸­å¯ç”¨ï¼Œæ­£åœ¨ç¦ç”¨..."
          sed -i 's/CONFIG_PACKAGE_rust=y/CONFIG_PACKAGE_rust=n/g' .config
        fi
        
        echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘"
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        
        # ä½¿ç”¨ä¼˜åŒ–çš„ç¼–è¯‘å‚æ•°
        make -j$(($(nproc) + 1)) || make -j$(nproc) || make -j2 || make -j1 V=s
        
        if [ $? -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "ç¼–è¯‘å¤±è´¥"
          exit 1
        fi

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´ (Check space usage)
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin ç›®å½• (Upload bin directory)
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin
        path: openwrt/bin

    - name: æ•´ç†æ–‡ä»¶ (Organize files)
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        
        # åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ï¼š"
        ls -la *.img *.gz *.vmdk *.vdi 2>/dev/null || true
        echo "æ ¹æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ï¼š"
        ls -la rootfs* 2>/dev/null || true
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½• (Upload firmware directory)
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware
        path: ${{ env.FIRMWARE }}
        retention-days: 30

    - name: ç¼–è¯‘æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "========================================"
        echo "ğŸ‰ OpenWrt å›ºä»¶ç¼–è¯‘æˆåŠŸï¼"
        echo "========================================"
        echo "è¯·åˆ° Artifacts ä¸‹è½½ç”Ÿæˆçš„å›ºä»¶"
        echo "========================================"

    - name: ç¼–è¯‘å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "========================================"
        echo "âŒ OpenWrt å›ºä»¶ç¼–è¯‘å¤±è´¥ï¼"
        echo "========================================"
        echo "å¸¸è§é—®é¢˜ï¼š"
        echo "1. Rust ç¼–è¯‘é”™è¯¯ï¼šå·²åœ¨æœ¬é…ç½®ä¸­ä¿®å¤"
        echo "2. ä¾èµ–ç¼ºå¤±ï¼šè¯·æ£€æŸ¥ feeds æ›´æ–°"
        echo "3. ç½‘ç»œé—®é¢˜ï¼šè¯·é‡è¯•æˆ–æ£€æŸ¥ GitHub ç½‘ç»œ"
        echo "========================================"
