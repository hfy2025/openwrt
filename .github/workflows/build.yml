name: Build OpenWrt x86-64

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: true
        default: 'v1.0'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置构建环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
          file wget curl

    - name: 克隆 OpenWrt 源码
      run: |
        git clone https://github.com/openwrt/openwrt.git -b openwrt-24.10 --depth 1
        cd openwrt
        echo "OpenWrt 版本:"
        git log --oneline -1

    - name: 应用自定义脚本
      run: |
        cd openwrt
        
        # 复制配置文件
        cp ../X86-64.config .config 2>/dev/null || echo "使用默认配置"
        
        # 执行 diy-part1.sh
        if [ -f ../diy-part1.sh ]; then
          echo "执行 diy-part1.sh..."
          chmod +x ../diy-part1.sh
          cp ../diy-part1.sh .
          ./diy-part1.sh
        fi
        
        # 执行 diy-part2.sh
        if [ -f ../diy-part2.sh ]; then
          echo "执行 diy-part2.sh..."
          chmod +x ../diy-part2.sh
          cp ../diy-part2.sh .
          ./diy-part2.sh
        fi

    - name: 更新 feeds
      run: |
        cd openwrt
        
        # 使用自定义 feeds 配置
        if [ -f ../feeds.conf.default ]; then
          cp ../feeds.conf.default .
        fi
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 配置编译
      run: |
        cd openwrt
        make defconfig
        echo "配置完成"

    - name: 下载依赖
      run: |
        cd openwrt
        echo "开始下载依赖包..."
        make -j$(nproc) download
        echo "清理无效下载文件..."
        find dl -size -1024c -delete 2>/dev/null || true

    - name: 编译固件
      run: |
        cd openwrt
        export FORCE_UNSAFE_CONFIGURE=1
        echo "开始编译固件..."
        make -j$(nproc) V=s

    - name: 检查编译结果
      run: |
        cd openwrt
        echo "编译结果:"
        ls -lh bin/targets/x86/64/ || echo "编译输出目录不存在"

    - name: 上传固件
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: OpenWrt-x86-64-固件
        path: openwrt/bin/targets/x86/64/*
        retention-days: 7

    - name: 上传配置和日志
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: 编译配置和日志
        path: |
          openwrt/.config
          openwrt/feeds.conf.default
          openwrt/build.log
        retention-days: 3
