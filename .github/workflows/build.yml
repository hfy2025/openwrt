#
# This workflow was generated by OpenWrt Action Gen
#
name: Build OpenWrt (编译固件)

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 检出代码 (Checkout)
      uses: actions/checkout@main

    - name: 释放磁盘空间 (Free Disk Space)
      run: |
        echo "Freeing up disk space..."
        echo "=========================================================="
        df -hT
        echo "=========================================================="
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        echo "=========================================================="
        df -hT
        echo "=========================================================="

    - name: 初始化编译环境 (Initialization environment)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: 克隆源码 (Clone source code)
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: 加载自定义 Feeds (diy-part1.sh)
      run: |
        # Apply Custom Feeds from UI
        
        
        # Write DIY Part 1 Script
        # 添加第三方插件源 (Feeds)
        # Kenzok8 (OpenClash, Nikki, HomeProxy 等)
        echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
        echo 'src-git small https://github.com/kenzok8/small' >> feeds.conf.default
        
        # iStore 和 NAS 相关 (Quickstart, iStore)
        echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
        echo 'src-git nas https://github.com/linkease/nas-packages.git;master' >> feeds.conf.default
        
        # Argon 主题 (手动克隆)
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/jerrykuku/luci-app-argon-config.git package/luci-app-argon-config
        
        chmod +x $DIY_P1_SH
        cd openwrt
        # Execute inline or file logic here. 
        # Applying DIY Part 1 Logic:
        # 添加第三方插件源 (Feeds)
        # Kenzok8 (OpenClash, Nikki, HomeProxy 等)
        echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
        echo 'src-git small https://github.com/kenzok8/small' >> feeds.conf.default
        
        # iStore 和 NAS 相关 (Quickstart, iStore)
        echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
        echo 'src-git nas https://github.com/linkease/nas-packages.git;master' >> feeds.conf.default
        
        # Argon 主题 (手动克隆)
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/jerrykuku/luci-app-argon-config.git package/luci-app-argon-config
        

    - name: 更新 Feeds (Update feeds)
      run: cd openwrt && ./scripts/feeds update -a

    - name: 安装 Feeds (Install feeds)
      run: cd openwrt && ./scripts/feeds install -a

    - name: 加载自定义配置 (diy-part2.sh)
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        cd openwrt
        
        # Applying DIY Part 2 Logic (System Settings):
        # 网络设置
        # 设置 LAN 口 IP 为 192.168.6.1
        sed -i 's/192.168.1.1/192.168.6.1/g' package/base-files/files/bin/config_generate
        
        # --- 千兆网络优化 (1000M 带宽跑满) ---
        
        # 1. 启用流量分载 (软件/硬件)
        # 对于 1000Mbps+ 速度至关重要，可降低 CPU 负载
        sed -i 's/option flow_offloading .*/option flow_offloading 1/' package/network/config/firewall/files/firewall.config
        sed -i '/option flow_offloading/a \
        \toption flow_offloading_hw 1' package/network/config/firewall/files/firewall.config
        
        # 2. 深度系统内核优化 (sysctl.conf)
        mkdir -p package/base-files/files/etc/sysctl.d
        cat <<EOF >> package/base-files/files/etc/sysctl.d/99-custom.conf
        # --- BBR 拥塞控制 ---
        net.core.default_qdisc=fq
        net.ipv4.tcp_congestion_control=bbr
        
        # --- 网络缓冲区优化 (针对千兆/万兆) ---
        # 增加接收和发送缓冲区大小
        net.core.rmem_default=262144
        net.core.wmem_default=262144
        net.core.rmem_max=16777216
        net.core.wmem_max=16777216
        net.ipv4.tcp_rmem=4096 87380 16777216
        net.ipv4.tcp_wmem=4096 65536 16777216
        
        # --- 连接跟踪与队列优化 ---
        net.core.netdev_max_backlog=16384
        net.core.somaxconn=8192
        net.ipv4.tcp_max_syn_backlog=8192
        net.ipv4.tcp_fastopen=3
        net.ipv4.tcp_keepalive_time=1200
        net.ipv4.tcp_window_scaling=1
        net.ipv4.tcp_timestamps=1
        
        # --- IPv6 专用优化 ---
        net.ipv6.conf.all.disable_ipv6=0
        net.ipv6.conf.default.disable_ipv6=0
        net.ipv6.conf.all.forwarding=1
        net.ipv6.conf.default.forwarding=1
        # 允许更多的 IPv6 路由表条目
        net.ipv6.route.max_size=4096
        # 邻居发现表大小 (防止局域网设备多时 ARP 满)
        net.ipv4.neigh.default.gc_thresh1=512
        net.ipv4.neigh.default.gc_thresh2=2048
        net.ipv4.neigh.default.gc_thresh3=4096
        net.ipv6.neigh.default.gc_thresh1=512
        net.ipv6.neigh.default.gc_thresh2=2048
        net.ipv6.neigh.default.gc_thresh3=4096
        EOF
        
        # 3. 在 rc.local 中启用数据包控制 (RPS)
        # 将网络中断分配到所有 CPU 核心
        sed -i "/exit 0/i \
        # 优化：启用数据包控制 (RPS)\n\
        for file in /sys/class/net/*/queues/rx-*/rps_cpus; do echo f > \$file; done\n\
        " package/base-files/files/etc/rc.local
        

        # Inject Auto Update Config if enabled


    - name: 生成 .config 文件 (Generate .config)
      run: |
        cd openwrt
        
        # Write custom .config content
        cat <<EOF >> .config
        # 目标架构: x86-64 (内核 6.6)
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        
        # 分区调整 (内核: 64MB, RootFS: 1024MB)
        CONFIG_TARGET_KERNEL_PARTSIZE=64
        CONFIG_TARGET_ROOTFS_PARTSIZE=1024
        
        # IPv6 支持
        CONFIG_IPV6=y
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y
        CONFIG_PACKAGE_6in4=y
        CONFIG_PACKAGE_6rd=y
        CONFIG_PACKAGE_6to4=y
        
        # 主题设置
        CONFIG_PACKAGE_luci-theme-argon=y
        CONFIG_PACKAGE_luci-theme-bootstrap=n
        CONFIG_PACKAGE_luci-app-argon-config=y
        
        # 千兆网络优化包
        CONFIG_PACKAGE_kmod-tcp-bbr=y
        CONFIG_DEFAULT_tcp_bbr=y
        CONFIG_PACKAGE_irqbalance=y
        CONFIG_PACKAGE_luci-app-turboacc=y
        
        EOF

        # Applying User Selected Packages via .config appending
        echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-appfilter=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-homeproxy=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-quickstart=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-taskplan=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-argon-config=y" >> .config
        
        # Set to default for missing values
        sed -i 's/^[ 	]*//;s/[ 	]*$//' .config
        make defconfig

    - name: 下载软件包 (Download package)
      id: package
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: 编译固件 (Compile the firmware)
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: 检查磁盘空间 (Check space usage)
      if: (!cancelled())
      run: df -hT

    - name: 上传 bin 目录 (Upload bin directory)
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin
        path: openwrt/bin

    - name: 整理文件 (Organize files)
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: 上传固件目录 (Upload firmware directory)
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware
        path: ${{ env.FIRMWARE }}
