name: Build ImmortalWrt X86-64

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (minimal recommended)'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - test

env:
  BUILD_DIR: /tmp/immortalwrt
  CCACHE_DIR: /tmp/ccache

jobs:
  build:
    runs-on: ubuntu-22.04
    #timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: Initial setup
      run: |
        echo "=== 初始设置 ==="
        df -h
        free -h
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install minimal dependencies
      run: |
        echo "安装依赖..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libncurses5-dev libssl-dev \
          python3 python3-distutils git wget \
          zlib1g-dev gettext gcc g++ make
        
    - name: Setup ccache
      run: |
        mkdir -p $CCACHE_DIR
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
        
    - name: Clone source
      run: |
        echo "克隆源码..."
        mkdir -p $BUILD_DIR
        cd $BUILD_DIR
        
        # 最小化克隆
        git clone --depth=1 \
          -b openwrt-25.12 \
          --single-branch \
          https://github.com/immortalwrt/immortalwrt.git .
          
        echo "源码大小:"
        du -sh .
        
    - name: Create minimal config
      run: |
        cd $BUILD_DIR
        
        echo "创建配置..."
        
        # 使用echo创建最小配置
        echo "CONFIG_TARGET_x86_64=y" > .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
        
        if [ "${{ github.event.inputs.build_type }}" = "test" ]; then
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_ethtool=y" >> .config
        fi
        
        make defconfig
        
    - name: Update and install feeds
      run: |
        cd $BUILD_DIR
        
        echo "更新feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Download packages with timeout
      timeout-minutes: 30
      run: |
        cd $BUILD_DIR
        
        echo "下载包..."
        echo "下载前磁盘空间:"
        df -h
        
        make download -j2 V=0
        
        echo "下载后磁盘空间:"
        df -h
        
    - name: Build with optimizations
      timeout-minutes: 120
      run: |
        cd $BUILD_DIR
        
        echo "开始编译..."
        echo "编译前磁盘空间:"
        df -h
        
        # 启用ccache加速
        export CCACHE_DIR=$CCACHE_DIR
        export CCACHE_MAXSIZE=1G
        
        # 分阶段编译
        echo "阶段1: 编译工具链..."
        make toolchain/install -j2 V=0
        
        echo "阶段2: 编译内核..."
        make target/linux/compile -j2 V=0
        
        echo "阶段3: 编译包..."
        make package/compile -j2 V=0
        
        echo "阶段4: 生成镜像..."
        make -j2 V=s 2>&1 | tail -100
        
    - name: Check results
      run: |
        cd $BUILD_DIR
        
        echo "检查结果..."
        
        # 查找固件
        if find bin/targets/x86/64 -name "*.img.gz" 2>/dev/null | grep -q .; then
          echo "✅ 编译成功！"
          
          # 复制固件
          mkdir -p $GITHUB_WORKSPACE/output
          cp bin/targets/x86/64/*.img.gz $GITHUB_WORKSPACE/output/ 2>/dev/null || true
          
          echo "生成的固件:"
          ls -lh $GITHUB_WORKSPACE/output/
        else
          echo "❌ 未找到固件"
          echo "可能的原因:"
          echo "1. 编译未完成"
          echo "2. 磁盘空间不足"
          echo "3. 配置错误"
          
          # 检查错误日志
          find . -name "*.log" -type f -exec tail -50 {} \; 2>/dev/null | tail -200 || true
        fi
        
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-firmware
        path: $GITHUB_WORKSPACE/output/
        
    - name: Cleanup
      if: always()
      run: |
        echo "清理..."
        rm -rf $BUILD_DIR $CCACHE_DIR 2>/dev/null || true
        
        echo "最终磁盘空间:"
        df -h
