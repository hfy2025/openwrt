name: Build ImmortalWrt X86-64

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_packages:
        description: 'è·³è¿‡åŒ…ä¸‹è½½ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰'
        required: false
        default: 'false'
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - minimal
          - debug
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-openwrt.yml'
      - 'configs/**'
      - 'scripts/**'
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥ UTC 0ç‚¹è‡ªåŠ¨ç¼–è¯‘

env:
  CPU_CORES: 4  # GitHub Actions æ ‡å‡† runner çš„æ ¸å¿ƒæ•°
  MAKE_JOBS: 5  # æ ¸å¿ƒæ•°+1 ä»¥è·å¾—æœ€ä½³ç¼–è¯‘é€Ÿåº¦
  BUILD_DIR: ${{ github.workspace }}/build
  ARTIFACT_NAME: ImmortalWrt-x86-64-$(date +%Y%m%d-%H%M%S)

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-dev \
          python3-pip python3-setuptools rsync subversion swig time xsltproc \
          zlib1g-dev unzip wget upx asciidoc bash bc binutils bzip2 cpio flex \
          g++-multilib gcc-multilib gperf haveged help2man intltool lib32gcc-s1 \
          libc6-dev-i386 libglib2.0-dev libtool libxml-parser-perl make \
          patch perl python3-venv scons tar tree uthash-dev uuid-dev \
          jq curl gnupg2 pigz p7zip-full cpio rsync
        
    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-immortalwrt-x86-64
        
    - name: Clone ImmortalWrt source
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        git clone --depth=1 -b openwrt-25.12 https://github.com/immortalwrt/immortalwrt.git
        cd immortalwrt
        echo "æºç å…‹éš†å®Œæˆï¼Œå½“å‰ç›®å½•: $(pwd)"
        echo "åˆ†æ”¯ä¿¡æ¯:"
        git branch -a
        echo "æœ€æ–°æäº¤:"
        git log -1 --oneline
        
    - name: Update feeds
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds æ›´æ–°å®Œæˆ"
        
    - name: Add custom plugins and themes
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        chmod +x ${{ github.workspace }}/scripts/add-plugins.sh
        ${{ github.workspace }}/scripts/add-plugins.sh
        
    - name: Apply configuration
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        # ä½¿ç”¨é¢„è®¾çš„ diffconfig
        if [ -f "${{ github.workspace }}/configs/x86-64-diffconfig" ]; then
          cp ${{ github.workspace }}/configs/x86-64-diffconfig .config
          make defconfig
          echo "å·²åº”ç”¨è‡ªå®šä¹‰é…ç½®"
        else
          # ä½¿ç”¨é»˜è®¤é…ç½®
          make menuconfig
          ./scripts/diffconfig.sh > ${{ github.workspace }}/configs/x86-64-diffconfig
          echo "å·²ä¿å­˜é»˜è®¤é…ç½®"
        fi
        
    - name: Download packages
      if: ${{ inputs.skip_packages != 'true' }}
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        make download -j${{ env.CPU_CORES }} V=s
        # éªŒè¯ä¸‹è½½å®Œæ•´æ€§
        find dl -size 0 -delete
        echo "åŒ…ä¸‹è½½å®Œæˆ"
        
    - name: Build firmware
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        # å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ç¼“å­˜åŠ é€Ÿ
        make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tee build.log
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if [ -f "bin/targets/x86/64/immortalwrt-x86-64-generic-squashfs-combined.img.gz" ]; then
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸï¼"
          ls -la bin/targets/x86/64/*.img*
        else
          echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          ${{ env.BUILD_DIR }}/immortalwrt/bin/targets/x86/64/*.img*
          ${{ env.BUILD_DIR }}/immortalwrt/bin/targets/x86/64/*.gz
          ${{ env.BUILD_DIR }}/immortalwrt/bin/targets/x86/64/*.manifest
        retention-days: 7
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ env.ARTIFACT_NAME }}
        path: |
          ${{ env.BUILD_DIR }}/immortalwrt/build.log
          ${{ env.BUILD_DIR }}/immortalwrt/.config
        retention-days: 30
        
    - name: Notify completion
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          echo "å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts åŒºåŸŸï¼Œåç§°ä¸º: ${{ env.ARTIFACT_NAME }}"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
        fi
