name: Build ImmortalWrt X86-64

on:
  workflow_dispatch:
    inputs:
      skip_packages:
        description: 'Skip package download'
        required: false
        default: 'false'
      build_type:
        description: 'Build type'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - standard
          - full

env:
  CPU_CORES: 2
  MAKE_JOBS: 3
  BUILD_DIR: ${{ github.workspace }}/build
  ARTIFACT_NAME: ImmortalWrt-x86-64-$(date +%Y%m%d-%H%M%S)

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: Check available disk space
      run: |
        df -h
        echo "Available space:"
        df -h /home/runner | tail -1
        
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false
        
    - name: Cleanup disk space
      run: |
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/doc/*
        sudo rm -rf /usr/share/man/*
        
        docker system prune -af 2>/dev/null || true
        
        rm -rf ~/.npm ~/.cache/pip
        
        echo "Disk space after cleanup:"
        df -h
        
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential ccache libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils \
          python3-dev git wget rsync subversion file gawk unzip \
          zlib1g-dev gettext gcc g++ make bash perl patch \
          ca-certificates
        
        sudo apt-get install -y --no-install-recommends \
          time xsltproc upx curl tar bzip2 cpio
        
        sudo apt-get clean
        
    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        git config --global maintenance.auto false
        git config --global gc.auto 0
        
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-immortalwrt-x86-64
        max-size: 500M
        
    - name: Clone ImmortalWrt source
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        git clone --depth=1 --single-branch \
          -b openwrt-25.12 \
          https://github.com/immortalwrt/immortalwrt.git
        
        cd immortalwrt
        echo "æºç å¤§å°:"
        du -sh .
        
    - name: Monitor disk space
      run: |
        echo "å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo "å·¥ä½œç›®å½•ä½¿ç”¨æƒ…å†µ:"
        du -sh ${{ github.workspace }}/* 2>/dev/null || true
        
    - name: Update feeds
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        ./scripts/feeds update -a
        
        if [ "${{ github.event.inputs.build_type || 'minimal' }}" = "minimal" ]; then
          ./scripts/feeds install -a -p packages
          ./scripts/feeds install -a -p luci
        else
          ./scripts/feeds install -a
        fi
        
    - name: Add custom plugins
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        echo "=== æ·»åŠ æ ¸å¿ƒæ’ä»¶ ==="
        
        if [ ! -d "package/luci-theme-argon" ]; then
            git clone --depth=1 https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        fi
        
        BUILD_TYPE="${{ github.event.inputs.build_type || 'minimal' }}"
        
        if [ "$BUILD_TYPE" != "minimal" ]; then
          if [ ! -d "package/passwall" ]; then
              git clone --depth=1 -b x86 https://github.com/xiaorouji/openwrt-passwall.git package/passwall
          fi
        fi
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Apply configuration
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        # åˆ›å»ºåŸºç¡€é…ç½®
        cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
CONFIG_TARGET_ROOTFS_PARTSIZE=1024
CONFIG_TARGET_KERNEL_PARTSIZE=16
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl-openssl=y
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_ethtool=y
CONFIG_PACKAGE_kmod-sched-cake=y
EOF
        
        BUILD_TYPE="${{ github.event.inputs.build_type || 'minimal' }}"
        
        if [ "$BUILD_TYPE" = "standard" ]; then
          cat >> .config << 'EOF'
CONFIG_PACKAGE_luci-app-adguardhome=y
CONFIG_PACKAGE_luci-app-turboacc=y
CONFIG_PACKAGE_luci-app-upnp=y
CONFIG_PACKAGE_luci-app-dockerman=y
CONFIG_PACKAGE_luci-app-cpufreq=y
CONFIG_PACKAGE_luci-app-samba4=y
EOF
        elif [ "$BUILD_TYPE" = "full" ] && [ -f "${{ github.workspace }}/configs/x86-64-diffconfig" ]; then
          cat "${{ github.workspace }}/configs/x86-64-diffconfig" >> .config
        fi
        
        make defconfig
        echo "é…ç½®å®Œæˆ:"
        ./scripts/diffconfig.sh
        
    - name: Clean before download
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        rm -rf tmp .config.old 2>/dev/null || true
        
    - name: Download packages
      if: ${{ github.event.inputs.skip_packages != 'true' }}
      continue-on-error: true
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        for i in 1 2 3; do
          echo "å°è¯•ä¸‹è½½åŒ… $i/3..."
          make download -j${{ env.CPU_CORES }} V=0 && break
          sleep 10
        done
        
        find dl -size 0 -delete 2>/dev/null || true
        
        echo "ä¸‹è½½çš„åŒ…å¤§å°:"
        du -sh dl/ || true
        
    - name: Check disk before build
      run: |
        echo "ç¼–è¯‘å‰çš„ç£ç›˜ç©ºé—´:"
        df -h
        echo "å·¥ä½œç›®å½•å¤§å°:"
        du -sh ${{ github.workspace }} 2>/dev/null || true
        
    - name: Build firmware
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        ulimit -s 8192
        ulimit -n 1024
        
        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        make -j${{ env.MAKE_JOBS }} target/linux/{clean,prepare} V=s 2>&1 | tee -a build_kernel.log
        
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        make -j${{ env.MAKE_JOBS }} V=0 2>&1 | tee build.log || make -j1 V=s 2>&1 | tee build_fallback.log
        
        IMG_PATH="bin/targets/x86/64"
        if [ -f "$IMG_PATH/immortalwrt-x86-64-generic-squashfs-combined.img.gz" ]; then
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸï¼"
          ls -lh $IMG_PATH/*.img*
          
          echo "æœ€ç»ˆå›ºä»¶å¤§å°:"
          du -sh $IMG_PATH/
        else
          echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
          find bin/ -name "*.img*" -o -name "*.gz" 2>/dev/null || true
          exit 1
        fi
        
    - name: Cleanup build artifacts
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        echo "æ¸…ç†ä¸­é—´æ–‡ä»¶..."
        
        echo "æ¸…ç†å‰å¤§å°:"
        du -sh . || true
        
        rm -rf build_dir/*/linux-* 2>/dev/null || true
        rm -rf build_dir/*/toolchain-* 2>/dev/null || true
        rm -rf staging_dir/* 2>/dev/null || true
        rm -rf tmp/* 2>/dev/null || true
        
        find . -name "*.o" -delete 2>/dev/null || true
        find . -name "*.a" -delete 2>/dev/null || true
        
        echo "æ¸…ç†åå¤§å°:"
        du -sh . || true
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          ${{ env.BUILD_DIR }}/immortalwrt/bin/targets/x86/64/*.img.gz
          ${{ env.BUILD_DIR }}/immortalwrt/bin/targets/x86/64/*.manifest
        retention-days: 7
        compression-level: 0
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ env.ARTIFACT_NAME }}
        path: |
          ${{ env.BUILD_DIR }}/immortalwrt/.config
          ${{ env.BUILD_DIR }}/immortalwrt/build.log
        retention-days: 30
        
    - name: Final disk report
      if: always()
      run: |
        echo "æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo "å·¥ä½œç›®å½•æœ€ç»ˆå¤§å°:"
        du -sh ${{ github.workspace }} 2>/dev/null || true
        
    - name: Notify completion
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼"
          echo "å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "è¯·æŸ¥çœ‹æ—¥å¿—"
        fi
