name: Build ImmortalWrt X86-64

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (minimal recommended)'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - standard

env:
  CPU_CORES: 1
  MAKE_JOBS: 2
  BUILD_DIR: /tmp/build-openwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Pre-cleanup disk space
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
        df -h
        
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/doc/
        sudo rm -rf /usr/share/man/
        sudo rm -rf /var/cache/
        
        docker system prune -af 2>/dev/null || true
        
        sudo journalctl --vacuum-time=1d
        sudo find /var/log -type f -name "*.log" -size +1M -delete 2>/dev/null || true
        
        echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
        df -h
        
    - name: Checkout repository (æœ€å°åŒ–)
      uses: actions/checkout@v4
        
    - name: Install only essential dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-dev \
          git wget rsync file gawk unzip zlib1g-dev gettext \
          gcc g++ make bash perl patch ca-certificates curl
        
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
    - name: Setup working directory
      run: |
        BUILD_DIR=/tmp/build-openwrt
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        mkdir -p $BUILD_DIR
        
    - name: Clone ImmortalWrt
      run: |
        cd ${{ env.BUILD_DIR }}
        
        git clone --depth=1 \
          -b openwrt-25.12 \
          https://github.com/immortalwrt/immortalwrt.git
        
        cd immortalwrt
        echo "æºç ç›®å½•å¤§å°:"
        du -sh .
        
    - name: Create minimal configuration
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        # ä½¿ç”¨echoå‘½ä»¤ä»£æ›¿heredocï¼Œé¿å…YAMLè¯­æ³•é—®é¢˜
        echo "# ç›®æ ‡æ¶æ„" > .config
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "" >> .config
        echo "# é•œåƒè®¾ç½®" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=256" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=8" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "" >> .config
        echo "# LuCIæœ€å°åŒ–" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "" >> .config
        echo "# åŸºç¡€ç½‘ç»œ" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-iprange=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-offload=y" >> .config
        echo "" >> .config
        echo "# ç³»ç»ŸåŸºç¡€" >> .config
        echo "CONFIG_PACKAGE_block-mount=y" >> .config
        echo "CONFIG_PACKAGE_fdisk=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        
        # æ ¹æ®æ„å»ºç±»å‹æ·»åŠ é¢å¤–é…ç½®
        if [ "${{ github.event.inputs.build_type }}" = "standard" ]; then
          echo "# Argonä¸»é¢˜" >> .config
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
          echo "" >> .config
          echo "# ç½‘ç»œå·¥å…·" >> .config
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_ethtool=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-cake=y" >> .config
          echo "" >> .config
          echo "# åŸºæœ¬æ’ä»¶" >> .config
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        fi
        
        make defconfig
        echo "é…ç½®å®Œæˆ"
        ./scripts/diffconfig.sh
        
    - name: Update feeds
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        ./scripts/feeds update packages luci
        ./scripts/feeds install -a
        
        echo "Feedsæ›´æ–°å®Œæˆ"
        
    - name: Download packages
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        echo "=== å¼€å§‹ä¸‹è½½åŒ… ==="
        
        for i in 1 2 3; do
          echo "ä¸‹è½½å°è¯• $i/3"
          make download -j1 V=0 && break
          sleep 15
        done
        
        find dl -size 0 -delete 2>/dev/null || true
        
        echo "ä¸‹è½½åŒ…å¤§å°:"
        du -sh dl/ 2>/dev/null || echo "æ— ä¸‹è½½åŒ…"
        
        echo "=== ä¸‹è½½åç£ç›˜ç©ºé—´ ==="
        df -h
        
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        echo "=== ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        ulimit -s 2048
        ulimit -n 512
        
        echo "å¼€å§‹ç¼–è¯‘..."
        make -j${{ env.MAKE_JOBS }} V=0
        
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥ç»“æœ..."
        
    - name: Check and collect build results
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        IMG_FILE=$(find bin/targets/x86/64 -name "*.img.gz" 2>/dev/null | head -1)
        
        if [ -f "$IMG_FILE" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "å›ºä»¶æ–‡ä»¶: $IMG_FILE"
          ls -lh "$IMG_FILE"
          
          mkdir -p $GITHUB_WORKSPACE/output
          cp "$IMG_FILE" $GITHUB_WORKSPACE/output/
          
          sha256sum "$IMG_FILE" > "$IMG_FILE.sha256sum"
          cp "$IMG_FILE.sha256sum" $GITHUB_WORKSPACE/output/
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          find bin/ -type f -name "*.img*" -o -name "*.bin" 2>/dev/null | head -10 || true
          exit 1
        fi
        
        echo "=== æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h
        
    - name: Post-build cleanup
      if: always()
      run: |
        echo "æ¸…ç†æ„å»ºç›®å½•..."
        rm -rf ${{ env.BUILD_DIR }} 2>/dev/null || true
        
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf /tmp/* 2>/dev/null || true
        
        echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
        df -h
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-minimal
        path: $GITHUB_WORKSPACE/output/
        retention-days: 5
        
    - name: Success notification
      if: success()
      run: |
        echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
        echo "å›ºä»¶å·²ä¸Šä¼ åˆ°ArtifactsåŒºåŸŸ"
        
    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ ç¼–è¯‘å¤±è´¥"
        echo "è¯·æ£€æŸ¥æ—¥å¿—"
