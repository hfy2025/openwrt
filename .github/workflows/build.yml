name: Build ImmortalWrt X86-64

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - light

env:
  MAKE_JOBS: 1
  BUILD_DIR: /tmp/immortalwrt-build

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
    - name: Initial disk space check
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
        df -h
        free -h
        
    - name: Cleanup system
      run: |
        echo "æ¸…ç†ç³»ç»Ÿç©ºé—´..."
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/doc/ /usr/share/man/
        sudo rm -rf /var/cache/apt/archives/
        
        echo "æ¸…ç†åç©ºé—´:"
        df -h
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install minimal dependencies
      run: |
        echo "å®‰è£…æœ€å°åŒ–ä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential libncurses5-dev libssl-dev \
          python3 python3-distutils git wget file gawk \
          zlib1g-dev gettext gcc g++ make bash
        
        sudo apt-get clean
        
    - name: Prepare build directory
      run: |
        echo "å‡†å¤‡æ„å»ºç›®å½•..."
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        
    - name: Clone ImmortalWrt with minimal options
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "å…‹éš†æºç ..."
        git init
        git remote add origin https://github.com/immortalwrt/immortalwrt.git
        git fetch --depth 1 origin openwrt-25.12
        git checkout FETCH_HEAD
        
        echo "æºç å¤§å°:"
        du -sh .
        
    - name: Create absolute minimal config
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "åˆ›å»ºæœ€å°åŒ–é…ç½®..."
        
        # ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤é¿å…heredocè¯­æ³•
        echo "CONFIG_TARGET_x86_64=y" > .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=256" >> .config
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
        # æ ¹æ®æ„å»ºç±»å‹æ·»åŠ é…ç½®
        if [ "${{ github.event.inputs.build_type }}" = "light" ]; then
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_ethtool=y" >> .config
        else
          # minimalæ„å»º - ç»å¯¹æœ€å°
          echo "CONFIG_BUSYBOX_CONFIG_FEATURE_VI_USE_SIGNALS=n" >> .config
          echo "CONFIG_BUSYBOX_CONFIG_FEATURE_EDITING=n" >> .config
        fi
        
        echo "é…ç½®å†…å®¹:"
        cat .config
        
    - name: Setup feeds (minimal)
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "æ›´æ–°feeds..."
        ./scripts/feeds update packages
        ./scripts/feeds install -a
        
    - name: Configure build
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "é…ç½®æ„å»º..."
        make defconfig
        
        echo "æœ€ç»ˆé…ç½®æ‘˜è¦:"
        ./scripts/diffconfig.sh
        
    - name: Download packages
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "ä¸‹è½½è½¯ä»¶åŒ…..."
        echo "å½“å‰ç£ç›˜ç©ºé—´:"
        df -h
        
        make download V=0 || make download V=s
        
        echo "ä¸‹è½½åç©ºé—´:"
        df -h
        
    - name: Build step-by-step
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        echo "ç¼–è¯‘å‰ç£ç›˜ç©ºé—´:"
        df -h
        
        # å°è¯•ç¼–è¯‘
        echo "ç¼–è¯‘ä¸­..."
        make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tail -200 || echo "ç¼–è¯‘å¯èƒ½æœ‰é—®é¢˜"
        
        echo "ç¼–è¯‘æ­¥éª¤å®Œæˆ..."
        
    - name: Check build results
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶..."
        
        # æ£€æŸ¥è¾“å‡º
        find . -name "*.img" -o -name "*.img.gz" -o -name "*.bin" 2>/dev/null | head -10
        
        if [ -d "bin/targets/x86/64" ]; then
          echo "x86/64 ç›®å½•å†…å®¹:"
          ls -la bin/targets/x86/64/ 2>/dev/null || true
        fi
        
    - name: Collect artifacts if successful
      if: success()
      run: |
        cd ${{ env.BUILD_DIR }}
        
        IMG_FILE=$(find bin/targets/x86/64 -name "*.img.gz" 2>/dev/null | head -1)
        
        if [ -f "$IMG_FILE" ]; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶: $IMG_FILE"
          ls -lh "$IMG_FILE"
          
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp "$IMG_FILE" $GITHUB_WORKSPACE/artifacts/
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶"
        fi
        
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-build
        path: $GITHUB_WORKSPACE/artifacts/
        retention-days: 3
        
    - name: Collect logs on failure
      if: failure()
      run: |
        cd ${{ env.BUILD_DIR }}
        
        echo "=== ç¼–è¯‘å¤±è´¥ï¼Œæ”¶é›†æ—¥å¿— ==="
        
        mkdir -p $GITHUB_WORKSPACE/logs
        
        # ç®€å•æ”¶é›†.logæ–‡ä»¶
        for log in $(find . -name "*.log" -type f 2>/dev/null | head -5); do
          echo "å¤åˆ¶æ—¥å¿—: $log"
          cp "$log" $GITHUB_WORKSPACE/logs/ 2>/dev/null || true
        done
        
    - name: Upload failure logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-logs
        path: $GITHUB_WORKSPACE/logs/
        retention-days: 7
        
    - name: Final cleanup
      if: always()
      run: |
        echo "=== æœ€ç»ˆæ¸…ç† ==="
        
        rm -rf ${{ env.BUILD_DIR }} 2>/dev/null || true
        rm -rf /tmp/* 2>/dev/null || true
        
        echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
        df -h
        
    - name: Success message
      if: success()
      run: |
        echo "ğŸ‰ ç¼–è¯‘æµç¨‹å®Œæˆï¼"
        echo "å›ºä»¶å·²ä¸Šä¼ åˆ°Artifacts"
        
    - name: Failure analysis
      if: failure()
      run: |
        echo "âŒ ç¼–è¯‘å¤±è´¥"
        echo "è¯·æŸ¥çœ‹æ—¥å¿—åˆ†æå…·ä½“åŸå› "
