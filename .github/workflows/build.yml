name: Build ImmortalWrt X86-64

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (minimal recommended)'
        required: true
        default: 'minimal'
        type: choice
        options:
          - minimal
          - standard

# ä½¿ç”¨è¾ƒä½å¹¶è¡Œåº¦å‡å°‘å†…å­˜å’Œç£ç›˜ä½¿ç”¨
env:
  CPU_CORES: 1
  MAKE_JOBS: 2
  BUILD_DIR: /tmp/build-openwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Pre-cleanup disk space
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
        df -h
        
        # æ¸…ç†ç³»ç»Ÿç¼“å­˜
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/doc/
        sudo rm -rf /usr/share/man/
        sudo rm -rf /var/cache/
        
        # æ¸…ç†Dockerï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        docker system prune -af 2>/dev/null || true
        
        # æ¸…ç†æ—¥å¿—æ–‡ä»¶
        sudo journalctl --vacuum-time=1d
        sudo find /var/log -type f -name "*.log" -size +1M -delete 2>/dev/null || true
        
        echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
        df -h
        
    - name: Checkout repository (æœ€å°åŒ–)
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          .github/workflows
          configs
        sparse-checkout-cone-mode: false
        
    - name: Install only essential dependencies
      run: |
        # åªå®‰è£…ç»å¯¹å¿…è¦çš„åŒ…
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-dev \
          git wget rsync file gawk unzip zlib1g-dev gettext \
          gcc g++ make bash perl patch ca-certificates curl
        
        # ç«‹å³æ¸…ç†ç¼“å­˜
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
    - name: Setup working directory in tmpfs (ä½¿ç”¨å†…å­˜æ–‡ä»¶ç³»ç»Ÿ)
      run: |
        # å°è¯•ä½¿ç”¨tmpfså‡å°‘ç£ç›˜IO
        if mount | grep -q /dev/shm; then
          echo "ä½¿ç”¨tmpfsæ„å»º..."
          BUILD_DIR=/dev/shm/build-openwrt
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        else
          echo "ä½¿ç”¨æ™®é€šç›®å½•æ„å»º..."
          BUILD_DIR=/tmp/build-openwrt
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        fi
        
        mkdir -p $BUILD_DIR
        
    - name: Clone ImmortalWrt (è¶…æµ…å…‹éš†)
      run: |
        cd ${{ env.BUILD_DIR }}
        
        # ä½¿ç”¨æœ€æµ…å…‹éš†
        git clone --depth=1 --no-single-branch \
          -b openwrt-25.12 \
          https://github.com/immortalwrt/immortalwrt.git
        
        cd immortalwrt
        echo "æºç ç›®å½•å¤§å°:"
        du -sh .
        
        # ç«‹å³æ¸…ç†gitå†å²
        rm -rf .git
        
    - name: Create minimal configuration
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        # åˆ›å»ºç»å¯¹æœ€å°åŒ–é…ç½®
        cat > .config << 'EOF'
# ç›®æ ‡æ¶æ„
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y

# é•œåƒè®¾ç½®
CONFIG_TARGET_ROOTFS_PARTSIZE=256
CONFIG_TARGET_KERNEL_PARTSIZE=8
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y

# LuCIæœ€å°åŒ–
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# åŸºç¡€ç½‘ç»œ
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
CONFIG_PACKAGE_iptables-mod-iprange=y
CONFIG_PACKAGE_kmod-ipt-offload=y

# ç³»ç»ŸåŸºç¡€
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_opkg=y
EOF
        
        # æ ¹æ®æ„å»ºç±»å‹æ·»åŠ é¢å¤–é…ç½®
        if [ "${{ github.event.inputs.build_type }}" = "standard" ]; then
          cat >> .config << 'EOF'
# Argonä¸»é¢˜
CONFIG_PACKAGE_luci-theme-argon=y

# ç½‘ç»œå·¥å…·
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_ethtool=y
CONFIG_PACKAGE_kmod-sched-cake=y

# åŸºæœ¬æ’ä»¶
CONFIG_PACKAGE_luci-app-upnp=y
CONFIG_PACKAGE_luci-app-turboacc=y
EOF
        fi
        
        make defconfig
        echo "é…ç½®å®Œæˆ"
        ./scripts/diffconfig.sh
        
    - name: Update feeds (é€‰æ‹©æ€§)
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        # åªæ›´æ–°å¿…è¦çš„feeds
        ./scripts/feeds update packages luci
        ./scripts/feeds install -a
        
        echo "Feedsæ›´æ–°å®Œæˆ"
        
    - name: Download packages with cleanup
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        echo "=== å¼€å§‹ä¸‹è½½åŒ… ==="
        
        # è®¾ç½®ä¸‹è½½è¶…æ—¶å’Œé‡è¯•
        for i in {1..3}; do
          echo "ä¸‹è½½å°è¯• $i/3"
          make download -j1 V=0 && break
          sleep 15
        done
        
        # ç«‹å³æ¸…ç†æ— æ•ˆçš„ä¸‹è½½æ–‡ä»¶
        find dl -size 0 -delete 2>/dev/null || true
        
        echo "ä¸‹è½½åŒ…å¤§å°:"
        du -sh dl/ 2>/dev/null || echo "æ— ä¸‹è½½åŒ…"
        
        # å†æ¬¡æ£€æŸ¥ç£ç›˜ç©ºé—´
        echo "=== ä¸‹è½½åç£ç›˜ç©ºé—´ ==="
        df -h
        
    - name: Build with aggressive space management
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        echo "=== ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        # è®¾ç½®èµ„æºé™åˆ¶
        ulimit -s 2048  # å‡å°‘æ ˆå¤§å°
        ulimit -n 512   # å‡å°‘æ–‡ä»¶æè¿°ç¬¦
        
        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        # å…ˆç¼–è¯‘å†…æ ¸ï¼Œå•ç‹¬æ­¥éª¤
        make target/linux/compile -j${{ env.MAKE_JOBS }} V=0 2>&1 | tee kernel_build.log
        
        # æ¸…ç†å†…æ ¸æ„å»ºä¸­é—´æ–‡ä»¶
        echo "æ¸…ç†å†…æ ¸æ„å»ºæ–‡ä»¶..."
        rm -rf build_dir/target-x86_64_musl/linux-x86_64 2>/dev/null || true
        
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        # ä½¿ç”¨æœ€å°‘è¾“å‡ºç¼–è¯‘
        make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tail -100
        
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥ç»“æœ..."
        
    - name: Check and collect build results
      run: |
        cd ${{ env.BUILD_DIR }}/immortalwrt
        
        # æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶
        IMG_FILE=$(find bin/targets/x86/64 -name "*.img.gz" 2>/dev/null | head -1)
        
        if [ -f "$IMG_FILE" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "å›ºä»¶æ–‡ä»¶: $IMG_FILE"
          ls -lh "$IMG_FILE"
          
          # å¤åˆ¶åˆ°å·¥ä½œç©ºé—´ä»¥ä¾¿ä¸Šä¼ 
          mkdir -p $GITHUB_WORKSPACE/output
          cp "$IMG_FILE" $GITHUB_WORKSPACE/output/
          
          # ç”Ÿæˆsha256æ ¡éªŒ
          sha256sum "$IMG_FILE" > "$IMG_FILE.sha256sum"
          cp "$IMG_FILE.sha256sum" $GITHUB_WORKSPACE/output/
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "æŸ¥æ‰¾ä»»ä½•å¯èƒ½çš„è¾“å‡ºæ–‡ä»¶..."
          find bin/ -type f -name "*.img*" -o -name "*.bin" 2>/dev/null | head -10 || true
          exit 1
        fi
        
        # æœ€ç»ˆç£ç›˜ä½¿ç”¨æŠ¥å‘Š
        echo "=== æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h
        
    - name: Post-build cleanup
      if: always()
      run: |
        echo "æ¸…ç†æ„å»ºç›®å½•..."
        rm -rf ${{ env.BUILD_DIR }} 2>/dev/null || true
        
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf /tmp/* 2>/dev/null || true
        
        echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
        df -h
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-minimal
        path: $GITHUB_WORKSPACE/output/
        retention-days: 5
        
    - name: Success notification
      if: success()
      run: |
        echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
        echo "ç”±äºGitHub Actionsç£ç›˜ç©ºé—´é™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æœ€å°åŒ–é…ç½®ã€‚"
        echo "è¦è·å¾—æ›´å¤šåŠŸèƒ½ï¼Œè¯·è€ƒè™‘ï¼š"
        echo "1. ä½¿ç”¨è‡ªæ‰˜ç®¡çš„Runnerï¼ˆ50GB+ç£ç›˜ç©ºé—´ï¼‰"
        echo "2. ä½¿ç”¨ä¸“ä¸šCIæœåŠ¡ï¼ˆå¦‚GitLab CIï¼‰"
        echo "3. åœ¨æœ¬åœ°æœºå™¨ä¸Šç¼–è¯‘"
        
    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ ç¼–è¯‘å¤±è´¥"
        echo "è¿™é€šå¸¸æ˜¯ç”±äºGitHub Actionsç£ç›˜ç©ºé—´ä¸è¶³ã€‚"
        echo "å»ºè®®è§£å†³æ–¹æ¡ˆï¼š"
        echo "1. ä½¿ç”¨è‡ªæ‰˜ç®¡Runnerï¼ˆæ¨èï¼‰"
        echo "2. ä½¿ç”¨æ›´ç²¾ç®€çš„é…ç½®"
        echo "3. è€ƒè™‘ä½¿ç”¨é¢„ç¼–è¯‘å›ºä»¶"
